rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Genel Kurallar: Varsayılan olarak tüm okuma ve yazma işlemlerini reddet.
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Profil Fotoğrafları için Özel Kurallar
    // Yol: /upload/avatars/{userId}/...
    match /upload/avatars/{userId}/{allPaths=**} {
      // Okuma İzni: Herkes (giriş yapmış veya yapmamış) profil fotoğraflarını görebilir.
      allow read;
      
      // Yazma İzni (Yükleme, Güncelleme, Silme):
      // Sadece giriş yapmış (request.auth != null) VE
      // kendi klasörüne (request.auth.uid == userId) işlem yapan kullanıcılar yazabilir.
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Oda Resimleri için Kurallar (Gelecekteki kullanım için)
    match /upload/rooms/{roomId}/{allPaths=**} {
      allow read;
      allow write: if request.auth != null;
    }

    // DM Resimleri için Kurallar (Gelecekteki kullanım için)
    match /dms/{chatId}/{allPaths=**} {
      allow read, write: if request.auth != null && resource.name.startsWith(request.auth.uid + '_') || resource.name.startsWith(chatId.split('_').find(uid => uid !== request.auth.uid));
    }
  }
}
