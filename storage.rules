rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // Genel kural: Varsayılan olarak tüm okuma ve yazma işlemlerini reddet.
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Profil fotoğrafları için kurallar
    match /upload/avatars/{userId}/{fileName} {
      // Herkes profil fotoğraflarını okuyabilir.
      allow read: if true;
      // Sadece giriş yapmış ve kendi klasörüne yazan kullanıcılar yazabilir.
      // Bu, bir kullanıcının sadece kendi profil fotoğrafını değiştirmesini sağlar.
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Gönderi resimleri için kurallar
    match /upload/posts/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Gönderi videoları için kurallar
    match /upload/videos/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Özel mesaj (DM) medyaları için kurallar
    match /dms/{chatId}/{allPaths=**} {
      // Sadece sohbete dahil olan kullanıcılar medyayı okuyabilir/yazabilir.
      // Bu kural, sohbetin katılımcı listesini Firestore'dan kontrol eder.
      allow read, write: if request.auth != null && request.auth.uid in get(/databases/(default)/documents/directMessagesMetadata/$(chatId)).data.participantUids;
    }
    
    // Oda içi müzik dosyaları için kurallar
    match /music/{roomId}/{allPaths=**} {
       // Sadece odaya dahil olan kullanıcılar medyayı okuyabilir/yazabilir.
       allow read, write: if request.auth != null && request.auth.uid in get(/databases/(default)/documents/rooms/$(roomId)).data.participantUids;
    }
  }
}
