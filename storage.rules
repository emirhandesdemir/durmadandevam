rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Allow users to upload their own profile pictures
    match /avatars/{userId}/profile.png {
      allow read;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow users to upload media to their own DMs
    match /dms/{chatId}/{mediaType}/{fileName} {
      // Users can only write to chats they are a part of.
      allow write: if request.auth != null && request.auth.uid in chatId.split('_');
      // Users can only read media from chats they are a part of.
      allow read: if request.auth != null && request.auth.uid in chatId.split('_');
    }
    
    // Allow anyone to read post images/videos
    match /upload/posts/{userId}/{fileName} {
      allow read;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow read access to music files for logged-in users
    match /music/{roomId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Simplification for now
    }
  }
}
