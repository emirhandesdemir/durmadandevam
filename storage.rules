rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Allow public read access for all uploaded files so users can see each other's content.
    match /{allPaths=**} {
      allow read;
    }

    // AVATARS: Users can only write to their own avatar folder.
    match /upload/avatars/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // POSTS: Users can only write to their own post image folder.
    match /upload/posts/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ROOMS: Any authenticated user can upload files to any room.
    // For enhanced security, this could be restricted to room participants.
    match /upload/rooms/{roomId}/{allPaths=**} {
      allow write: if request.auth != null;
    }

    // DMs: Users can only write to chats they are a part of.
    // The chatId is a concatenation of two sorted UIDs, so this check works for both participants.
    match /dms/{chatId}/{allPaths=**} {
      allow write: if request.auth != null && chatId.matches(request.auth.uid);
    }
  }
}