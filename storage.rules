rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Allow public read access to all files
    match /{allPaths=**} {
      allow read;
    }

    // --- AVATARS ---
    // Allow a user to only write (create, update, delete) to their own avatar folder.
    // The filename must be 'profile.png'.
    match /avatars/{userId}/profile.png {
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }
    
    // --- POSTS ---
    // Allow an authenticated user to write to a folder matching their UID inside 'upload/posts'.
    match /upload/posts/{userId}/{allPaths=**} {
       allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024 // 10MB limit
                   && request.resource.contentType.matches('image/.*');
    }

    // --- VIDEOS ---
    // Allow an authenticated user to write to a folder matching their UID inside 'upload/videos'.
    match /upload/videos/{userId}/{allPaths=**} {
       allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 50 * 1024 * 1024 // 50MB limit
                   && request.resource.contentType.matches('video/.*');
    }
    
    // --- DIRECT MESSAGES ---
    // Allow an authenticated user to write to a DM folder they are a part of.
    match /dms/{chatId}/{allPaths=**} {
      allow write: if request.auth != null && chatId.split('_').includes(request.auth.uid)
                   && request.resource.size < 10 * 1024 * 1024 // 10MB limit
                   && (request.resource.contentType.matches('image/.*') || request.resource.contentType.matches('audio/.*'));
    }
  }
}
