rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // GENEL KURAL: Varsayılan olarak tüm okuma ve yazma işlemlerini reddet.
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // AVATARS: Kullanıcıların sadece kendi avatarlarını yazmasına izin ver.
    // Herkes başkalarının avatarını okuyabilir.
    match /avatars/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // POSTS (GÖNDERİLER): Kullanıcıların sadece kendi gönderi resimlerini yazmasına izin ver.
    // Herkes gönderi resimlerini okuyabilir.
    match /upload/posts/{userId}/{allPaths=**} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
    }

    // DM_UPLOADS: Kullanıcıların, katılımcısı oldukları bir sohbete dosya yüklemesine izin ver.
    // Bu, en güvenli ve doğru yöntemdir.
    match /dm_uploads/{chatId}/{fileName} {
      allow read: if request.auth != null && exists(/databases/$(database)/documents/directMessagesMetadata/$(chatId.replace(" ", ""))) && request.auth.uid in get(/databases/$(database)/documents/directMessagesMetadata/$(chatId.replace(" ", ""))).data.participantUids;
      allow write: if request.auth != null && exists(/databases/$(database)/documents/directMessagesMetadata/$(chatId.replace(" ", ""))) && request.auth.uid in get(/databases/$(database)/documents/directMessagesMetadata/$(chatId.replace(" ", ""))).data.participantUids;
    }

    // MUSIC: Sesli sohbet odalarına müzik yükleme
    match /music/{roomId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Oda katılımcısı kontrolü eklenebilir.
    }
  }
}
